<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 WiFi Configuration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container { 
            max-width: 500px; margin: 0 auto; 
            background: white; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white; padding: 25px; text-align: center;
        }
        .content { padding: 25px; }
        .status { 
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border-left: 4px solid;
        }
        .status.connected { background: #e8f5e8; border-color: #4CAF50; color: #2e7d32; }
        .status.disconnected { background: #ffebee; border-color: #f44336; color: #c62828; }
        .status.config { background: #fff3e0; border-color: #ff9800; color: #e65100; }
        .network-list { margin: 20px 0; }
        .network-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; margin: 8px 0; border-radius: 8px;
            background: #f8f9fa; border: 1px solid #e9ecef;
            cursor: pointer; transition: all 0.3s;
        }
        .network-item:hover { background: #e9ecef; transform: translateY(-1px); }
        .network-info { flex: 1; }
        .network-name { font-weight: 600; margin-bottom: 4px; }
        .network-details { font-size: 12px; color: #666; }
        .signal-strength { 
            width: 30px; height: 20px; position: relative;
            margin-left: 10px;
        }
        .signal-bar { 
            position: absolute; bottom: 0; width: 4px;
            background: #ddd; border-radius: 1px;
        }
        .signal-bar.active { background: #4CAF50; }
        .signal-bar:nth-child(1) { left: 0; height: 25%; }
        .signal-bar:nth-child(2) { left: 6px; height: 50%; }
        .signal-bar:nth-child(3) { left: 12px; height: 75%; }
        .signal-bar:nth-child(4) { left: 18px; height: 100%; }
        input[type="password"] { 
            width: 100%; padding: 12px; margin: 10px 0;
            border: 1px solid #ddd; border-radius: 8px;
            font-size: 16px;
        }
        .btn { 
            padding: 12px 24px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 16px; transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .modal { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content { 
            background: white; padding: 30px; border-radius: 15px;
            width: 90%; max-width: 400px; text-align: center;
        }
        .controls { text-align: center; margin: 20px 0; }
        .nav-btn {
            background: rgba(255,255,255,0.2); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            transition: all 0.3s; font-size: 14px;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button class="nav-btn" onclick="goToDashboard()">üìä Dashboard</button>
                <button class="nav-btn" onclick="refreshStatus()">üîÑ Refresh</button>
            </div>
            <h1>üåê WiFi Configuration</h1>
            <p>ESP32 Network Setup</p>
        </div>
        
        <div class="content">
            <div id="status" class="status disconnected">
                <strong>Status:</strong> <span id="status-text">Disconnected</span>
                <div id="status-details"></div>
            </div>
            
            <div style="text-align: center; margin: 20px 0; padding: 20px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                <h3 style="color: #1976D2; margin-bottom: 15px;">üìä System Dashboard</h3>
                <button class="btn btn-primary" onclick="goToDashboard()" style="font-size: 18px; padding: 15px 30px;">
                    Go to Dashboard
                </button>
                <div style="font-size: 14px; color: #1976D2; margin-top: 10px;">
                    View sensors, control LEDs and monitor system status
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="scanNetworks()">üîç Scan Networks</button>
                <button class="btn btn-secondary" onclick="refreshStatus()">üîÑ Refresh</button>
                <button class="btn btn-danger" onclick="disconnect()">‚ùå Disconnect</button>
                <button class="btn btn-danger" onclick="clearCredentials()">üóëÔ∏è Clear Saved</button>
            </div>
            
            <div id="loading" class="loading hidden">
                <p>üì° Scanning for networks...</p>
            </div>
            
            <div id="network-list" class="network-list"></div>
        </div>
    </div>
    
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>üîê Enter Password</h3>
            <p>Network: <strong id="selected-ssid"></strong></p>
            <input type="password" id="password-input" placeholder="Enter WiFi password">
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="connectToNetwork()">Connect</button>
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let selectedSSID = '';
        
        function initWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws`);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                refreshStatus();
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected, reconnecting...');
                setTimeout(initWebSocket, 3000);
            };
        }
        
        function handleWebSocketMessage(data) {
            if (data.type === 'status') {
                updateStatus(data);
            } else if (data.type === 'networks') {
                updateNetworkList(data.list);
            } else if (data.type === 'connect_result') {
                if (data.success) {
                    alert('‚úÖ Connected successfully!');
                    closeModal();
                    refreshStatus();
                } else {
                    alert('‚ùå Connection failed: ' + data.message);
                }
            } else if (data.type === 'credentials_cleared') {
                alert('üóëÔ∏è Saved credentials cleared');
                refreshStatus();
            }
        }
        
        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            const statusTextEl = document.getElementById('status-text');
            const statusDetailsEl = document.getElementById('status-details');
            
            if (status.connected) {
                statusEl.className = 'status connected';
                statusTextEl.textContent = `Connected to ${status.ssid}`;
                statusDetailsEl.innerHTML = `IP: ${status.ip} | Signal: ${status.rssi} dBm`;
            } else if (status.config_mode) {
                statusEl.className = 'status config';
                statusTextEl.textContent = 'Configuration Mode';
                statusDetailsEl.innerHTML = 'Connect to this device to configure WiFi';
            } else {
                statusEl.className = 'status disconnected';
                statusTextEl.textContent = 'Disconnected';
                statusDetailsEl.innerHTML = 'Not connected to any network';
            }
        }
        
        function goToDashboard() {
            window.location.href = `${window.location.protocol}//${window.location.host}/dashboard`;
        }
        
        function updateNetworkList(networks) {
            const listEl = document.getElementById('network-list');
            const loadingEl = document.getElementById('loading');
            
            loadingEl.classList.add('hidden');
            
            if (networks.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #666;">No networks found</p>';
                return;
            }
            
            listEl.innerHTML = networks.map(network => {
                const signalBars = Math.ceil(network.strength / 25);
                const lockIcon = network.secured ? 'üîí' : 'üîì';
                
                return `
                    <div class="network-item" onclick="selectNetwork('${network.ssid}', ${network.secured})">
                        <div class="network-info">
                            <div class="network-name">${lockIcon} ${network.ssid}</div>
                            <div class="network-details">${network.rssi} dBm | ${network.secured ? 'Secured' : 'Open'}</div>
                        </div>
                        <div class="signal-strength">
                            ${[1,2,3,4].map(i => `<div class="signal-bar ${i <= signalBars ? 'active' : ''}"></div>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function scanNetworks() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('network-list').innerHTML = '';
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'scan'}));
            }
        }
        
        function selectNetwork(ssid, secured) {
            selectedSSID = ssid;
            document.getElementById('selected-ssid').textContent = ssid;
            
            if (secured) {
                document.getElementById('passwordModal').style.display = 'flex';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            } else {
                connectToNetwork();
            }
        }
        
        function connectToNetwork() {
            const password = document.getElementById('password-input').value;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'connect',
                    ssid: selectedSSID,
                    password: password
                }));
            }
        }
        
        function disconnect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'disconnect'}));
            }
        }
        
        function clearCredentials() {
            if (confirm('Clear saved WiFi credentials?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({action: 'clear_credentials'}));
                }
            }
        }
        
        function refreshStatus() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({action: 'get_status'}));
            }
        }
        
        function closeModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }
        
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connectToNetwork();
            }
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('passwordModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        initWebSocket();
    </script>
</body>
</html>