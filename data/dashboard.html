<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container { 
            max-width: 600px; margin: 0 auto; 
            background: white; border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white; padding: 25px; text-align: center;
        }
        .nav-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        .nav-btn {
            background: rgba(255,255,255,0.2); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            transition: all 0.3s; font-size: 14px;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
        .content { padding: 25px; }
        .status { 
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            border-left: 4px solid;
        }
        .status.connected { background: #e8f5e8; border-color: #4CAF50; color: #2e7d32; }
        .status.disconnected { background: #ffebee; border-color: #f44336; color: #c62828; }
        .sensor-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin: 20px 0;
        }
        .sensor-card {
            background: #f8f9fa; border-radius: 12px; padding: 20px;
            border: 1px solid #e9ecef; text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .sensor-icon { font-size: 48px; margin-bottom: 15px; }
        .sensor-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .sensor-label { font-size: 14px; color: #666; margin-bottom: 10px; }
        .sensor-status { font-size: 12px; padding: 4px 8px; border-radius: 12px; }
        .temp-card { border-left: 4px solid #ff5722; }
        .humidity-card { border-left: 4px solid #2196F3; }
        .light-card { border-left: 4px solid #FFC107; }
        .led-controls {
            background: #f8f9fa; border-radius: 12px; padding: 20px;
            margin: 20px 0; text-align: center;
        }
        .led-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-top: 15px;
        }
        .led-control {
            background: white; border-radius: 8px; padding: 15px;
            border: 2px solid #e9ecef; transition: all 0.3s;
        }
        .led-control.active {
            border-color: #4CAF50; background: #e8f5e8;
        }
        .btn { 
            padding: 12px 24px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 16px; transition: all 0.3s;
            margin: 5px; width: 100%;
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #FFC107; color: #333; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .refresh-section {
            text-align: center; margin: 20px 0;
        }
        .last-update {
            font-size: 12px; color: #666; margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-header">
                <button class="nav-btn" onclick="goToWifiConfig()">‚öôÔ∏è WiFi Config</button>
                <button class="nav-btn" onclick="refreshAll()">üîÑ Refresh</button>
            </div>
            <h1>üìä ESP32 Dashboard</h1>
            <p>Sensor Monitoring & Control</p>
        </div>
        
        <div class="content">
            <!-- Connection Status -->
            <div id="status" class="status disconnected">
                <strong>üì° Connection:</strong> <span id="status-text">Checking...</span>
                <div id="status-details"></div>
            </div>
            
            <!-- Sensor Data Grid -->
            <div class="sensor-grid">
                <!-- Temperature -->
                <div class="sensor-card temp-card">
                    <div class="sensor-icon">üå°Ô∏è</div>
                    <div class="sensor-value" id="temperature">--¬∞C</div>
                    <div class="sensor-label">Temperature</div>
                    <div class="sensor-status" id="temp-status">--</div>
                </div>
                
                <!-- Humidity -->
                <div class="sensor-card humidity-card">
                    <div class="sensor-icon">üíß</div>
                    <div class="sensor-value" id="humidity">--%</div>
                    <div class="sensor-label">Humidity</div>
                    <div class="sensor-status" id="humidity-status">--</div>
                </div>
                
                <!-- Light Sensor -->
                <div class="sensor-card light-card" id="light-card">
                    <div class="sensor-icon">üí°</div>
                    <div class="sensor-value" id="light-level">--</div>
                    <div class="sensor-label">Light Level</div>
                    <div class="sensor-status">
                        Auto LED: <strong><span id="auto-led-status">--</span></strong>
                    </div>
                </div>
            </div>
            
            <!-- LED Controls -->
            <div class="led-controls">
                <h3 style="margin-bottom: 15px;">üí° LED Controls</h3>
                <div class="led-grid">
                    <div class="led-control" id="led-control">
                        <h4>Manual LED (GPIO 48)</h4>
                        <button id="led-btn" class="btn btn-secondary" onclick="toggleLED()">
                            <span id="led-status">OFF</span>
                        </button>
                    </div>
                    
                    <div class="led-control" id="neo-control">
                        <h4>NeoPixel (GPIO 45)</h4>
                        <button id="neo-btn" class="btn btn-secondary" onclick="toggleNeo()">
                            <span id="neo-status">OFF</span>
                        </button>
                    </div>
                    
                    <div class="led-control" id="auto-control">
                        <h4>Auto LED (GPIO 2)</h4>
                        <div style="font-size: 14px; color: #666; margin: 5px 0;">
                            Controlled by Light Sensor
                        </div>
                        <div class="sensor-status" style="background: #e3f2fd; color: #1976D2;">
                            Status: <span id="auto-led-display">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="last-update" id="last-update">
                Last update: --
            </div>
        </div>
    </div>

    <script>
        let ws;
        
        function initWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws`);
            
            ws.onopen = function() {
                console.log('Dashboard WebSocket connected');
                document.getElementById('status-text').textContent = 'WebSocket Connected';
                refreshAll();
            };
            
            ws.onmessage = function(event) {
                console.log('Dashboard received:', event.data);
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('Dashboard WebSocket disconnected, reconnecting...');
                document.getElementById('status-text').textContent = 'WebSocket Disconnected';
                setTimeout(initWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('Dashboard WebSocket error:', error);
                document.getElementById('status-text').textContent = 'WebSocket Error';
            };
        }
        
        function handleWebSocketMessage(data) {
            if (data.type === 'status') {
                updateStatus(data);
            } else if (data.type === 'sensors') {
                updateSensorData(data);
            } else if (data.type === 'leds') {
                updateLEDStatus(data);
            } else if (data.type === 'light') {
                updateLightSensorData(data);
            }
        }
        
        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            const statusTextEl = document.getElementById('status-text');
            const statusDetailsEl = document.getElementById('status-details');
            
            if (status.connected) {
                statusEl.className = 'status connected';
                statusTextEl.textContent = `Connected to ${status.ssid}`;
                statusDetailsEl.innerHTML = `IP: ${status.ip} | Signal: ${status.rssi} dBm`;
            } else {
                statusEl.className = 'status disconnected';
                statusTextEl.textContent = 'Not Connected';
                statusDetailsEl.innerHTML = 'Check WiFi configuration';
            }
        }
        
        function updateSensorData(data) {
            const tempEl = document.getElementById('temperature');
            const humidityEl = document.getElementById('humidity');
            const lightLevelEl = document.getElementById('light-level');
            const tempStatusEl = document.getElementById('temp-status');
            const humidityStatusEl = document.getElementById('humidity-status');
            const autoLedStatusEl = document.getElementById('auto-led-status');
            const autoLedDisplayEl = document.getElementById('auto-led-display');
            
            if (data.valid) {
                tempEl.textContent = `${data.temperature.toFixed(1)}¬∞C`;
                humidityEl.textContent = `${data.humidity.toFixed(1)}%`;
                lightLevelEl.textContent = `${data.light_level || 0}`;
                
                tempStatusEl.textContent = 'Normal';
                tempStatusEl.style.background = '#e8f5e8';
                tempStatusEl.style.color = '#2e7d32';
                
                humidityStatusEl.textContent = 'Normal';
                humidityStatusEl.style.background = '#e8f5e8';
                humidityStatusEl.style.color = '#2e7d32';
            } else {
                tempEl.textContent = 'Error';
                humidityEl.textContent = 'Error';
                lightLevelEl.textContent = 'Error';
                
                tempStatusEl.textContent = 'Error';
                tempStatusEl.style.background = '#ffebee';
                tempStatusEl.style.color = '#c62828';
                
                humidityStatusEl.textContent = 'Error';
                humidityStatusEl.style.background = '#ffebee';
                humidityStatusEl.style.color = '#c62828';
            }
            
            // Update light sensor display
            if (data.light_level !== undefined) {
                updateLightSensorDisplay(data.light_level, data.led_state);
            }
            
            const now = new Date();
            document.getElementById('last-update').textContent = `Last update: ${now.toLocaleTimeString()}`;
        }
        
        function updateLightSensorData(data) {
            updateLightSensorDisplay(data.light_level, data.led_state);
        }
        
        function updateLightSensorDisplay(lightLevel, ledState) {
            const lightCard = document.getElementById('light-card');
            const autoLedStatusEl = document.getElementById('auto-led-status');
            const autoLedDisplayEl = document.getElementById('auto-led-display');
            const autoControlEl = document.getElementById('auto-control');
            
            autoLedStatusEl.textContent = ledState ? 'ON' : 'OFF';
            autoLedDisplayEl.textContent = ledState ? 'ON' : 'OFF';
            
            if (ledState) {
                autoControlEl.classList.add('active');
            } else {
                autoControlEl.classList.remove('active');
            }
            
            // Change card appearance based on light level
            if (lightLevel < 500) {
                lightCard.style.background = '#263238';
                lightCard.style.color = '#fff';
                lightCard.style.borderLeftColor = '#FFC107';
            } else {
                lightCard.style.background = '#f8f9fa';
                lightCard.style.color = '#333';
                lightCard.style.borderLeftColor = '#FFC107';
            }
        }
        
        function updateLEDStatus(data) {
            const ledStatusEl = document.getElementById('led-status');
            const neoStatusEl = document.getElementById('neo-status');
            const ledBtnEl = document.getElementById('led-btn');
            const neoBtnEl = document.getElementById('neo-btn');
            const ledControlEl = document.getElementById('led-control');
            const neoControlEl = document.getElementById('neo-control');
            
            // Update manual LED
            ledStatusEl.textContent = data.led_state ? 'ON' : 'OFF';
            ledBtnEl.className = data.led_state ? 'btn btn-primary' : 'btn btn-secondary';
            if (data.led_state) {
                ledControlEl.classList.add('active');
            } else {
                ledControlEl.classList.remove('active');
            }
            
            // Update NeoPixel
            neoStatusEl.textContent = data.neo_state ? 'ON' : 'OFF';
            neoBtnEl.className = data.neo_state ? 'btn btn-primary' : 'btn btn-secondary';
            if (data.neo_state) {
                neoControlEl.classList.add('active');
            } else {
                neoControlEl.classList.remove('active');
            }
        }
        
        function toggleLED() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const currentState = document.getElementById('led-status').textContent === 'ON';
                ws.send(JSON.stringify({
                    action: 'control_led',
                    state: !currentState
                }));
            }
        }
        
        function toggleNeo() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const currentState = document.getElementById('neo-status').textContent === 'ON';
                ws.send(JSON.stringify({
                    action: 'control_neo', 
                    state: !currentState
                }));
            }
        }
        
        function refreshAll() {
            console.log('Dashboard refreshAll called, WebSocket state:', ws ? ws.readyState : 'null');
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('Sending dashboard refresh requests...');
                ws.send(JSON.stringify({action: 'get_status'}));
                ws.send(JSON.stringify({action: 'get_sensors'}));
                ws.send(JSON.stringify({action: 'get_leds'}));
                ws.send(JSON.stringify({action: 'get_light'}));
            } else {
                console.log('Dashboard WebSocket not ready, state:', ws ? ws.readyState : 'null');
            }
        }
        
        function goToWifiConfig() {
            window.location.href = `${window.location.protocol}//${window.location.host}/wifi-config`;
        }
        
        initWebSocket();
        
        // Auto refresh every 5 seconds
        setInterval(refreshAll, 5000);
    </script>
</body>
</html>